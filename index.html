<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de QR Dinámico - Elegante</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --color-negro: #0a0a0a;
            --color-dorado: #d4af37;
            --color-blanco: #ffffff;
            --color-gris-claro: #f5f5f5;
            --color-gris-oscuro: #2a2a2a;
            --color-rojo: #e74c3c;
            --color-texto: #333333;
            --font-family: 'Georgia', serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; font-family: var(--font-family ); }
        .app-wrapper { width: 100%; min-height: 100vh; background: var(--color-blanco); color: var(--color-texto); overflow-x: hidden; }
        .video-container, .login-container, .main-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--color-gris-claro) 0%, var(--color-blanco) 100%); padding: 20px; position: relative; }
        .login-container, .main-container { display: none; }
        .video-wrapper { position: relative; width: 90%; max-width: 800px; background-color: var(--color-blanco); border-radius: 8px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); border: 3px solid var(--color-dorado); }
        .video-wrapper video { width: 100%; height: auto; display: block; }
        .skip-button { position: absolute; top: 20px; right: 20px; padding: 12px 24px; font-size: 16px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; color: var(--color-blanco); background: var(--color-negro); border: 2px solid var(--color-dorado); border-radius: 4px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); z-index: 10; }
        .skip-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5); background: var(--color-gris-oscuro); }
        .login-box, .main-content, .modal-content { background: var(--color-gris-claro); border: 2px solid var(--color-dorado); border-radius: 8px; padding: 40px; transition: all 0.3s ease; position: relative; overflow: hidden; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(212, 175, 55, 0.1); }
        .main-content { max-width: 600px; }
        .login-box h1, .main-header h1, .modal-header h2 { font-size: 28px; font-weight: 300; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 20px; background: linear-gradient(135deg, var(--color-negro) 0%, var(--color-dorado) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-align: center; }
        .main-header p, .modal-header p { color: var(--color-texto); font-size: 14px; text-align: center; }
        .form-group, .url-section, .settings-item { margin-bottom: 20px; }
        .form-group label, .url-section label, .settings-item label { display: block; margin-bottom: 8px; color: var(--color-negro); font-weight: 600; }
        .form-group input, .url-input-wrapper input, .settings-input-wrapper input { width: 100%; padding: 12px; border: 1px solid var(--color-gris-oscuro); border-radius: 4px; background-color: var(--color-blanco); color: var(--color-negro); font-size: 16px; transition: border-color 0.3s ease; }
        .form-group input:focus, .url-input-wrapper input:focus, .settings-input-wrapper input:focus { outline: none; border-color: var(--color-dorado); box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .url-input-wrapper { display: flex; gap: 10px; }
        .url-input-wrapper input { flex: 1; }
        .login-button, .btn, .edit-button, .btn-guardar, .btn-cancelar { padding: 14px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .login-button { width: 100%; margin-top: 10px; }
        .btn-actualizar, .btn-programar, .login-button, .btn-guardar { background-color: var(--color-negro); color: var(--color-blanco); border: 2px solid var(--color-dorado); }
        .btn-actualizar:hover, .btn-programar:hover, .login-button:hover, .btn-guardar:hover { background-color: var(--color-gris-oscuro); color: var(--color-dorado); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4); }
        .btn-cerrar { background-color: var(--color-rojo); color: var(--color-blanco); }
        .btn-cerrar:hover { background-color: #ff6666; transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255, 68, 68, 0.4); }
        .edit-button { padding: 10px 15px; background-color: var(--color-dorado); color: var(--color-negro); border: none; text-transform: none; letter-spacing: normal; }
        .edit-button:hover { background-color: #f4d03f; transform: scale(1.05); }
        .btn-cancelar { background-color: var(--color-gris-claro); color: var(--color-negro); border: 1px solid var(--color-gris-oscuro); }
        .btn-cancelar:hover { background-color: var(--color-blanco); transform: translateY(-2px); }
        .qr-section { text-align: center; margin-bottom: 30px; padding: 20px; background-color: var(--color-blanco); border-radius: 8px; border: 2px solid var(--color-dorado); }
        #qrCode { display: inline-block; padding: 10px; background-color: var(--color-blanco); border-radius: 4px; margin-bottom: 15px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); padding-top: 60px; }
        .modal-content { margin: 5% auto; max-width: 500px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; }
        .progress-bar { display: none; width: 100%; height: 4px; background-color: var(--color-gris-oscuro); border-radius: 2px; margin-bottom: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--color-dorado), var(--color-negro)); width: 0%; animation: progress 2s ease-in-out forwards; }
        @keyframes progress { 0% { width: 0%; } 50% { width: 100%; } 100% { width: 100%; } }
        .update-message { display: none; text-align: center; color: var(--color-dorado); font-weight: bold; margin-top: 10px; animation: fadeInOut 3s ease-in-out; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        .error-message { color: var(--color-rojo); font-size: 14px; margin-top: 10px; text-align: center; }
        .success-message { color: var(--color-dorado); font-size: 14px; margin-top: 10px; text-align: center; }
        .button-group { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        @media (max-width: 768px) { .login-box, .main-content, .modal-content { padding: 25px; } .url-input-wrapper { flex-direction: column; } .url-input-wrapper input { margin-bottom: 10px; } .modal-buttons { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div id="videoScreen" class="video-container">
            <div class="video-wrapper">
                <video id="presentationVideo" controls autoplay muted>
                    <source src="https://github.com/cartasinteractivas-jpg/qrmanager/raw/main/qrdinamicopresentacion.mp4" type="video/mp4">
                    Tu navegador no soporta el elemento de video.
                </video>
                <button class="skip-button" onclick="skipVideo( )">Saltar Video</button>
            </div>
        </div>

        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <h1>Iniciar Sesión</h1>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Usuario</label>
                        <input type="text" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="login-button">Entrar</button>
                    <div id="loginError" class="error-message"></div>
                </form>
            </div>
        </div>

        <div id="mainScreen" class="main-container">
            <div class="main-content">
                <div class="main-header">
                    <h1>Tu QR Dinámico</h1>
                    <p>Gestiona tu código QR y cambios de dirección</p>
                </div>
                <div class="qr-section">
                    <div id="qrCode"></div>
                </div>
                <div class="url-section">
                    <label>Dirección Actual</label>
                    <div class="url-input-wrapper">
                        <input type="text" id="urlInput" placeholder="https://ejemplo.com" readonly>
                        <button class="edit-button" onclick="enableEditUrl( )">Editar</button>
                    </div>
                </div>
                <div id="progressBar" class="progress-bar"><div class="progress-fill"></div></div>
                <div id="updateMessage" class="update-message">✓ Dirección actualizada correctamente</div>
                <div class="button-group">
                    <button class="btn btn-actualizar" onclick="updateUrl()">Actualizar</button>
                    <button class="btn btn-programar" onclick="openScheduleModal()">Programar</button>
                    <button class="btn btn-programar" onclick="openSettingsModal()">Ajustes</button>
                    <button class="btn btn-cerrar" onclick="logout()">Cerrar Sesión</button>
                </div>
            </div>
        </div>

        <div id="scheduleModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Programar Cambio de Dirección</h2>
                    <p>Puede cambiar la dirección según la fecha programada (3 opciones de cambio)</p>
                </div>
                <div id="scheduleItems"></div>
                <div class="modal-buttons">
                    <button class="btn-guardar" onclick="saveSchedule()">Guardar</button>
                    <button class="btn-cancelar" onclick="closeScheduleModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Cambia de usuario y contraseña</h2>
                </div>
                <div class="settings-form">
                    <div class="settings-item">
                        <label>Usuario</label>
                        <div class="settings-input-wrapper">
                            <input type="text" id="settingsUser" placeholder="Usuario" readonly>
                            <button class="edit-button" onclick="enableEditSettingsUser()">Editar</button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>Contraseña</label>
                        <div class="settings-input-wrapper">
                            <input type="password" id="settingsPassword" placeholder="Contraseña" readonly>
                            <button class="edit-button" onclick="enableEditSettingsPassword()">Editar</button>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-guardar" onclick="updateUserSettings()">Actualizar</button>
                    <button class="btn-cancelar" onclick="closeSettingsModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- INICIO DEL SCRIPT ---

    // 1. CONFIGURACIÓN E INICIALIZACIÓN
    const SUPABASE_URL = 'https://flcxihzwyexgigavztce.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsY3hpaHp3eWV4Z2lnYXZ6dGNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyODI0MzAsImV4cCI6MjA3OTg1ODQzMH0.7Ur3LcihnR6wIEM7QjFxNIe4ci2TmIVVt8ZcvekFSqA';
    
    let supabase;
    let currentUserData = null; // Almacenará todos los datos del usuario logueado

    // Inicializar la aplicación cuando la ventana cargue
    window.addEventListener('load', ( ) => {
        const { createClient } = window.supabase;
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Cargar último usuario para facilitar el login
        const lastUser = localStorage.getItem('lastUser');
        if (lastUser) {
            document.getElementById('email').value = lastUser;
        }
        
        // Listener para el formulario de login
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
    });

    // 2. NAVEGACIÓN Y UI
    function skipVideo() {
        document.getElementById('videoScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
    }

    function showMainScreen() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'flex';
    }

    function showLoginScreen() {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('password').value = ''; // Limpiar contraseña
    }

    // 3. LÓGICA DE AUTENTICACIÓN Y DATOS
    async function handleLogin(event) {
        event.preventDefault();
        const usuario = document.getElementById('email').value;
        const clave = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = '';

        try {
            // Hacemos una consulta para encontrar la fila exacta que coincida
            const { data, error } = await supabase
                .from('qrs')
                .select('*')
                .eq('usuario', usuario)
                .eq('clave', clave)
                .single(); // .single() asegura que solo esperamos un resultado

            if (error || !data) {
                errorDiv.textContent = 'Usuario o contraseña incorrectos.';
                return;
            }

            // Si se encuentra, guardamos TODOS los datos de esa fila
            currentUserData = data;
            localStorage.setItem('lastUser', usuario);
            
            // Cargamos los datos en la interfaz
            loadUserData();
            showMainScreen();

        } catch (error) {
            errorDiv.textContent = 'Error en la autenticación: ' + error.message;
        }
    }

    function loadUserData() {
        if (!currentUserData) return;
        
        document.getElementById('urlInput').value = currentUserData.url_activo;
       generateQRCode(currentUserData.qr_imagen);

        renderScheduleItems();
    }

    function logout() {
        currentUserData = null;
        showLoginScreen();
    }

    // 4. FUNCIONALIDAD DEL QR Y URL
   // 4. FUNCIONALIDAD DEL QR Y URL
function generateQRCode(imageUrl) {
    const qrCodeDiv = document.getElementById('qrCode');
    qrCodeDiv.innerHTML = ''; // Limpiamos el contenedor por si acaso

    // Verificamos si hay una URL de imagen válida
    if (imageUrl) {
        // Creamos un elemento de imagen
        const img = document.createElement('img');
        
        // Le asignamos la URL de la columna qr_imagen
        img.src = imageUrl; 
        
        // Le damos un estilo para que se ajuste al contenedor
        img.style.width = '180px';
        img.style.height = '180px';
        img.style.objectFit = 'contain'; // 'contain' para que se vea completa sin deformarse
        
        // Añadimos la imagen al div
        qrCodeDiv.appendChild(img);
    }
}


    function enableEditUrl() {
        const urlInput = document.getElementById('urlInput');
        urlInput.readOnly = false;
        urlInput.focus();
        urlInput.select();
    }

    async function updateUrl() {
        const urlInput = document.getElementById('urlInput');
        const newUrl = urlInput.value.trim();

        if (!newUrl || newUrl === currentUserData.url_activo) {
            urlInput.readOnly = true;
            return;
        }

        const progressBar = document.getElementById('progressBar');
        const updateMessage = document.getElementById('updateMessage');
        progressBar.style.display = 'block';
        updateMessage.style.display = 'none';

        try {
            // Actualizamos la fila usando el ID que guardamos en el login
            const { error } = await supabase
                .from('qrs')
                .update({ url_activo: newUrl })
                .eq('id', currentUserData.id);

            if (error) throw error;

            currentUserData.url_activo = newUrl; // Actualizamos nuestros datos locales
            // ¡CORRECCIÓN! Usamos la URL de la imagen que ya tenemos, no la nueva URL de texto.
generateQRCode(currentUserData.qr_imagen);

            urlInput.readOnly = true;
            
            progressBar.style.display = 'none';
            updateMessage.style.display = 'block';
            setTimeout(() => updateMessage.style.display = 'none', 3000);

        } catch (error) {
            alert('Error al actualizar la URL: ' + error.message);
            progressBar.style.display = 'none';
        }
    }

    // 5. LÓGICA DE MODALES (PROGRAMACIÓN Y AJUSTES)
    function openScheduleModal() { document.getElementById('scheduleModal').style.display = 'block'; }
    function closeScheduleModal() { document.getElementById('scheduleModal').style.display = 'none'; }
    function openSettingsModal() { 
        document.getElementById('settingsUser').value = currentUserData.usuario;
        document.getElementById('settingsPassword').value = currentUserData.clave;
        document.getElementById('settingsModal').style.display = 'block';
    }
    function closeSettingsModal() { document.getElementById('settingsModal').style.display = 'none'; }

    // Reemplaza la función original con esta
function renderScheduleItems() {
    const container = document.getElementById('scheduleItems');
    container.innerHTML = '';

    // 1. OBTENER LA FECHA Y HORA ACTUAL EN FORMATO LOCAL
    const now = new Date();
    // Ajustamos la zona horaria para que coincida con la del usuario
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    // Formateamos a 'YYYY-MM-DDTHH:MM' que es lo que el input necesita
    const minDateTime = now.toISOString().slice(0, 16);

    for (let i = 1; i <= 3; i++) {
        // Obtenemos los valores guardados de la base de datos
        const savedTimestamp = currentUserData[`programa${i}`];
        let savedDate = '';
        let savedTime = '';

        if (savedTimestamp) {
            const d = new Date(savedTimestamp);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            savedDate = d.toISOString().split('T')[0]; // 'YYYY-MM-DD'
            savedTime = d.toISOString().split('T')[1].slice(0, 5); // 'HH:MM'
        }
        
        const urlValue = currentUserData[`url_programado${i}`] || '';
        
        const item = document.createElement('div');
        item.className = 'settings-item';
        
        // 2. CREAMOS DOS INPUTS SEPARADOS: UNO PARA FECHA Y OTRO PARA HORA
        item.innerHTML = `
            <label>Cambio Programado ${i}</label>
            <div class="settings-input-wrapper">
                <input 
                    type="date" 
                    id="scheduleDate${i}" 
                    value="${savedDate}"
                    min="${minDateTime.split('T')[0]}"  // Límite para la fecha
                >
                <input 
                    type="time" 
                    id="scheduleTime${i}" 
                    value="${savedTime}"
                >
            </div>
            <div class="settings-input-wrapper" style="margin-top: 10px;">
                 <input 
                    type="url" 
                    id="scheduleUrl${i}" 
                    placeholder="URL a cambiar" 
                    value="${urlValue}"
                >
            </div>
        `;
        container.appendChild(item);
    }
}


    async function saveSchedule() {
        const updates = {};
        for (let i = 1; i <= 3; i++) {
            updates[`url_programado${i}`] = document.getElementById(`scheduleUrl${i}`).value;
            const datePart = document.getElementById(`scheduleDate${i}`).value;
const timePart = document.getElementById(`scheduleTime${i}`).value;
// Unimos fecha y hora. Si falta alguna, se guarda como nulo.
const dateValue = (datePart && timePart) ? `${datePart}T${timePart}` : null;

            updates[`programa${i}`] = dateValue ? new Date(dateValue).toISOString() : null;
        }

        try {
            const { data, error } = await supabase
                .from('qrs')
                .update(updates)
                .eq('id', currentUserData.id)
                .select()
                .single();

            if (error) throw error;
            
            currentUserData = data; // Actualizar datos locales
            alert('Programación guardada correctamente');
            closeScheduleModal();

        } catch (error) {
            alert('Error al guardar la programación: ' + error.message);
        }
    }

    function enableEditSettingsUser() { document.getElementById('settingsUser').readOnly = false; document.getElementById('settingsUser').focus(); }
    function enableEditSettingsPassword() { const passInput = document.getElementById('settingsPassword'); passInput.type = 'text'; passInput.readOnly = false; passInput.focus(); }

    async function updateUserSettings() {
        const newUser = document.getElementById('settingsUser').value.trim();
        const newPassword = document.getElementById('settingsPassword').value.trim();

        if (!newUser || !newPassword) {
            alert('El usuario y la contraseña no pueden estar vacíos.');
            return;
        }

        try {
            const { data, error } = await supabase
                .from('qrs')
                .update({ usuario: newUser, clave: newPassword })
                .eq('id', currentUserData.id)
                .select()
                .single();

            if (error) throw error;

            currentUserData = data;
            localStorage.setItem('lastUser', newUser);
            alert('Usuario y contraseña actualizados correctamente.');
            closeSettingsModal();

        } catch (error) {
            alert('Error al actualizar los datos: ' + error.message);
        }
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('scheduleModal')) closeScheduleModal();
        if (event.target == document.getElementById('settingsModal')) closeSettingsModal();
    }
</script>

</body>
</html>



